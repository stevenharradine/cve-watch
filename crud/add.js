var redis      = require("redis"),
    client     = redis.createClient(),
    itemsToAdd = new Array ();

client.on("error", function (err) {
	console.log("Error " + err);
});

module.exports.addToList = function (listname, rawArgs, verbose) {
	// taken from http://stackoverflow.com/questions/784012/javascript-equivalent-of-phps-in-array on 20150518 @ 19:50 EST
	var inArray = function (needle, haystack) {
		var length = haystack.length;
		for(var i = 0; i < length; i++) {
			if(haystack[i] == needle) return true;
		}
		return false;
	};

	rawArgs.forEach(function (val, index, array) {
		// skip the first two element ['node', 'add-to-list']
		if (index >= 2)
			itemsToAdd.push (val);
	});

	client.get (listname, function (err, reply) {
		if (reply != null) {
			var hasChanged = false;
			list = JSON.parse(reply.toString());

			itemsToAdd.forEach (function (val, index, array) {
				if (!inArray (val, list)) {
					if (verbose) console.log ("pushing " + val + " to array");

					list.push (val);
					hasChanged = true;
				} else {
					if (verbose) console.log ("item already on " + listname);
				}
			});

			if (hasChanged) {
				if (verbose) console.log ("pushing array back to redis");
				client.set (listname, JSON.stringify (list), function (err, reply) {
					if (err != null) console.log ("ERROR:" + err);
					client.quit();
				});
			} else {
				client.quit();
			}
		} else {
			if (verbose) console.log ("adding first item(s) " + itemsToAdd + " to " + listname);
			client.set (listname, JSON.stringify (itemsToAdd), function (err, reply) {
				client.quit();
			});
		}
	});
};
var redis         = require("redis"),
    listname      = process.argv[2];
    itemsToRemove = process.argv.splice(3),
    validLists    = ["watchlist", "emaillist", "slackloglist", "slackalertlist"];

// TODO: add/remove both use this same function, need to abstract out
// taken from http://stackoverflow.com/questions/784012/javascript-equivalent-of-phps-in-array on 20150518 @ 19:50 EST
function inArray (needle, haystack) {
	var length = haystack.length;
	for(var i = 0; i < length; i++) {
		if(haystack[i] == needle) return true;
	}
	return false;
};

function removeFromlist (listname, rawArgs, verbose) {
	var client = redis.createClient();

	client.on("error", function (err) {
		console.log("Error " + err);
	});

	client.get (listname, function (err, reply) {
		if (reply != null) {
			list = JSON.parse(reply.toString());

			// TODO: redis saves on every iteratoin need to move saving out of the loop
			itemsToRemove.forEach (function (itemToRemove, index, array) {
				if (inArray (itemToRemove, list)) {
					var redisSaveClient = redis.createClient();

					redisSaveClient.on("error", function (err) {
						console.log("Error " + err);
					});

					if (verbose) console.log ("removing '" + itemToRemove + "' from " + listname);

					list.splice (list.indexOf(itemToRemove), 1);
					
					redisSaveClient.set (listname, JSON.stringify (list), function (err, reply) {
						redisSaveClient.quit();
						client.quit();
					});
				} else {
					if (verbose) console.log ("'" + itemToRemove + "' not found in " + listname);
					client.quit();
				}
			});
		} else {
			console.log ("error");
		}
	});
}

if (inArray (listname, validLists)) {
	removeFromlist (listname, itemsToRemove, true);
} else {
	console.log ("Error: '" + listname + "' is not a valid list name please use " + validLists);
}